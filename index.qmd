---
title: "Buffalo Creek Flood Risk Assessment"
author: "Sazzad Hossain"
subtitle: "Find whether any infrastructure is at risk of flooding"
date: 2025-11-20
date-format: long
code-fold: true
code-tools:
  toggle: true
format:
  html:
    theme: default
    toc: true
    toc-depth: 3
    self-contained: true
---

```{r message=FALSE, warning=FALSE}
library(nhdplusTools)
library(sf)
library(terra)
library(elevatr)
library(dataRetrieval)
library(osmdata)
library(ggplot2)
library(dplyr)
library(leaflet)
library(htmlwidgets)
library(knitr)
library(tmap)
```

```{r message=FALSE, warning=FALSE}
#Define Buffalo Creek study area
bbox_coords <- c(xmin = -78.85, ymin = 42.80, xmax = -78.65, ymax = 42.92)
study_bbox <- st_bbox(bbox_coords, crs = 4326)
study_area <- st_as_sfc(study_bbox) |> st_sf()

#Download DEM
dem_raw <- get_elev_raster(locations = study_area, z = 13, src = "aws")
dem <- rast(dem_raw)
writeRaster(dem, "data/buffalo_dem.tif", overwrite = TRUE)

print(paste("DEM Resolution:", res(dem), "meters"))
rng <- minmax(dem)
print(paste("Elevation range:", round(rng[1]), "to", round(rng[2]), "meters"))

#Visualize DEM

plot(dem)
```

## Stream Extraction

```{r message=FALSE, warning=FALSE}
library(nhdplusTools)
library(sf)

# Define area of interest as sf polygon (not bbox)

aoi <- st_as_sfc(st_bbox(c(
  xmin = -78.9,
  ymin = 42.75,
  xmax = -78.6,
  ymax = 42.95
), crs = 4326))



# Download flowlines for the area
flowlines <- get_3dhp(AOI = aoi, type = "flowline")

# Filter for Buffalo Creek
buffalo_creek <- flowlines |>
  filter(grepl("Buffalo", gnisidlabel, ignore.case = TRUE))

# Visualize just the stream
plot(st_geometry(buffalo_creek), col = "blue", lwd = 2, main = "Buffalo Creek Stream Network")
```
```{r message=FALSE, warning=FALSE}
buffalo_creek_proj <- st_transform(buffalo_creek, crs = 32617) # UTM zone for your area
stream_buffer <- st_buffer(buffalo_creek_proj, dist = 500) # 500 meters

# Transform back to WGS84 for plotting or OSM intersection
stream_buffer_wgs84 <- st_transform(stream_buffer, crs = 4326)

# Plot buffer and stream
plot(st_geometry(stream_buffer_wgs84), col = rgb(1,0,0,0.2), main = "Buffalo Creek 500m Flood Buffer")
plot(st_geometry(buffalo_creek), col = "blue", lwd = 2, add = TRUE)


```

```{r message=FALSE, warning=FALSE}
# Define the study area polygon for OSM query
bbox <- st_bbox(stream_buffer_wgs84)

# Get buildings from OSM
buildings_osm <- opq(bbox = bbox) %>%
  add_osm_feature(key = "building") %>%
  osmdata_sf()

# Extract building polygons
buildings <- buildings_osm$osm_polygons

# Ensure same CRS for intersection
buildings <- st_transform(buildings, st_crs(stream_buffer_wgs84))
```

```{r message=FALSE, warning=FALSE}
buildings_at_risk <- st_intersection(buildings, stream_buffer_wgs84)

# Check how many buildings are affected
cat("Number of buildings at risk:", nrow(buildings_at_risk), "\n")

```

```{r message=FALSE, warning=FALSE}
library(tmap)

# Static plot for Quarto rendering
tmap_mode("plot")

tm_shape(stream_buffer_wgs84) +
  tm_fill(col = "red", alpha = 0.2) +
  tm_shape(buffalo_creek) +
  tm_lines(col = "blue") +
  tm_shape(buildings) +
  tm_polygons(col = "grey", alpha = 0.5) +
  tm_shape(buildings_at_risk) +
  tm_polygons(col = "orange", alpha = 0.8)


```
```{r message=FALSE, warning=FALSE}
library(ggplot2)

# Total number of buildings
total_buildings <- nrow(buildings)

# Number of buildings at risk
at_risk <- nrow(buildings_at_risk)

# Number of buildings not at risk
not_at_risk <- total_buildings - at_risk

# Create summary data frame
summary_df <- data.frame(
  Status = c("At Risk", "Not at Risk"),
  Count = c(at_risk, not_at_risk)
)

# Print summary table
knitr::kable(summary_df, caption = "Summary of Buildings at Risk")

# Plot the summary
ggplot(summary_df, aes(x = Status, y = Count, fill = Status)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = Count), vjust = -0.5, size = 5) +
  scale_fill_manual(values = c("orange", "grey")) +
  labs(title = "Buildings at Risk vs Not at Risk",
       x = "", y = "Number of Buildings") +
  theme_minimal() +
  theme(legend.position = "none",
        text = element_text(size = 14))

```
